<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Market & Housing Dashboard — v6 FINAL (Hydrated)</title>

<style>
  :root{
    --bg1:#f6f8ff; --bg2:#eef7ff;
    --text:#0f172a; --muted:#475569; --soft:#64748b;
    --card:#ffffff; --border:#e6e9f2; --primary:#0b63f6;
    --ok:#16a34a; --bad:#dc2626; --flat:#64748b;
    --accentA:#e9f1ff; --accentB:#f0e9ff;
    --radius:14px; --shadow:0 10px 32px rgba(10,14,25,.10);
    --fz:16px; --fz-sm:14px; --fz-lg:18px;
    --pad:18px; --gap:16px; --maxw:1240px;
  }
  *{box-sizing:border-box}
  body{
    margin:0;color:var(--text);font:var(--fz)/1.7 Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    background:linear-gradient(180deg, var(--bg1), var(--bg2)) fixed;
  }
  body::before, body::after{
    content:""; position:fixed; top:0; bottom:0; width:10px; pointer-events:none;
    background:linear-gradient(180deg, var(--accentA), transparent 60%);
  }
  body::before{ left:0 }
  body::after{ right:0; background:linear-gradient(180deg, var(--accentB), transparent 60%) }

  a{color:#0b63f6;text-decoration:none}
  header{position:sticky;top:0;z-index:1000;background:rgba(255,255,255,.9);backdrop-filter:blur(8px);border-bottom:1px solid var(--border)}
  .wrap{max-width:var(--maxw);margin:0 auto;padding:12px var(--pad)}
  .bar{display:flex;align-items:center;justify-content:space-between;gap:12px}
  .brand{display:flex;align-items:center;gap:10px;font-weight:800;font-size:20px}
  .logo{width:30px;height:30px;border-radius:9px;background:linear-gradient(135deg,#0b63f6,#7c3aed)}
  .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .btn{background:#0b63f6;color:#fff;padding:9px 13px;border-radius:10px;cursor:pointer;border:1px solid #0b5be0;box-shadow:var(--shadow);font-weight:600}
  .btn.secondary{background:#fff;color:#0b63f6;border:1px solid var(--border)}
  .chip{background:#eef2ff;color:#1e293b;border:1px solid var(--border);padding:6px 10px;border-radius:999px;font-size:var(--fz-sm)}

  main{padding:var(--pad)}
  .grid{display:grid;gap:22px;grid-template-columns:1fr}
  .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden}
  .card h3{margin:0;padding:14px var(--pad);background:linear-gradient(180deg,#ffffff,#fbfbff);border-bottom:1px solid var(--border);font-size:var(--fz-lg);color:#1f2937;letter-spacing:.2px}
  .content{padding:var(--pad)}

  /* KPI grid */
  .kpis{display:grid;gap:14px;grid-template-columns:repeat(4,1fr)}
  .kpi{display:flex;flex-direction:column;gap:10px;background:#fff;border:1px solid var(--border);border-radius:12px;padding:12px}
  .kpi .label{color:#0f172a;font-size:15px;font-weight:800}
  .kpi-sub{border:1px dashed var(--border);border-radius:10px;padding:10px;background:#fcfdff}
  .sub-label{color:#64748b;font-size:12px;text-transform:uppercase;letter-spacing:.4px;margin-bottom:6px}
  .value{font-size:24px;font-weight:800}
  .delta{font-size:13px;color:#475569}
  .pos{color:var(--ok)} .neg{color:var(--bad)} .flat{color:var(--flat)}
  .fine{color:#64748b;font-size:12px}

  /* Type toggle */
  .toggle{display:inline-flex;border:1px solid var(--border);border-radius:12px;overflow:hidden;background:#fff}
  .toggle button{padding:8px 12px;border:none;background:#fff;color:#0b63f6;font-weight:700;cursor:pointer}
  .toggle button.active{background:#0b63f6;color:#fff}
  .toggle button+button{border-left:1px solid var(--border)}

  /* Watchlist */
  .stocks-wrap{max-height:520px;overflow:auto;border:1px solid var(--border);border-radius:12px;background:#fff}
  .stock-row{display:grid;grid-template-columns:110px 180px 1fr 120px 120px;gap:10px;align-items:center;padding:12px 14px;border-bottom:1px dashed var(--border)}
  .stock-row:last-child{border-bottom:none}
  .ticker{font-weight:800;color:#111827}
  .name{color:#1f2937;font-weight:600}
  .desc{color:#475569;font-size:14px}
  .price{font-variant-numeric:tabular-nums}

  /* FEED */
  .feed-wrap{max-height:680px;overflow:auto;border:1px solid var(--border);border-radius:12px;background:#fff;padding:14px}
  .section-title{margin:14px 0 10px;font-weight:800;color:#1f2937;font-size:var(--fz-lg)}
  .block{border:1px solid var(--border);border-radius:12px;background:#fff;padding:14px;margin-bottom:14px}
  .block h4{margin:0 0 8px;font-size:17px;color:#111827}
  .lines{display:grid;gap:6px}
  .label{color:#64748b;font-size:var(--fz-sm);width:180px;display:inline-block}
  .text{color:#0f172a}
  .summary{border:2px dashed var(--border);border-radius:12px;background:#fcfdff;padding:14px;font-weight:600}

  @media (max-width: 1000px){ .kpis{grid-template-columns:repeat(2,1fr)} }
  @media (max-width: 640px){ .kpis{grid-template-columns:1fr} }
</style>
</head>
<body>
<header>
  <div class="wrap bar">
    <div class="brand"><div class="logo"></div><div>Market & Housing — v6 FINAL</div></div>
    <div class="toolbar">
      <span class="chip">Updated: <span id="lastUpdated">—</span></span>
      <button class="btn secondary" id="copyFeed">Copy FEED</button>
      <button class="btn secondary" id="downloadTxt">Export FEED TXT</button>
      <button class="btn secondary" id="refreshTakeaways">Refresh Takeaways</button>
      <button class="btn" id="downloadHtml">Download HTML</button>
    </div>
  </div>
</header>

<main>
  <div class="wrap grid">

    <!-- 1) MACRO SNAPSHOT -->
    <div class="card">
      <h3>Macro Snapshot</h3>
      <div class="content">
        <div class="kpis">
          <div class="kpi"><div class="label">S&amp;P 500</div><div class="value" id="spx">—</div><div class="delta" id="spxDelta"></div></div>
          <div class="kpi"><div class="label">10Y UST</div><div class="value" id="ust10">—</div><div class="delta" id="ust10Delta"></div></div>
          <div class="kpi"><div class="label">30Y Mortgage (PMMS)</div><div class="value" id="mort30">—</div><div class="delta" id="mort30Delta"></div></div>
          <div class="kpi"><div class="label">Housing Starts (SAAR)</div><div class="value" id="starts">—</div><div class="delta" id="startsDelta"></div></div>
        </div>
      </div>
    </div>

    <!-- 2) FLORIDA PERMITS — Latest + YTD + DOM with Type Toggle -->
    <div class="card">
      <h3>Florida Metro Permits — Latest Month + YTD + Days on Market</h3>
      <div class="content">
        <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px">
          <span class="fine" style="font-weight:700">Type:</span>
          <div class="toggle" id="typeToggle">
            <button class="active" data-type="total">Total</button>
            <button data-type="1unit">1-Unit</button>
          </div>
        </div>

        <div class="kpis" id="flPermitsKPI">
          <!-- Four tiles are in the DOM already; we hydrate them -->
          <div class="kpi">
            <div class="label">Orlando–Kissimmee–Sanford</div>
            <div class="kpi-sub"><div class="sub-label">Latest Month · Units authorized (NSA) — Total</div><div class="value">—</div><div class="delta"></div></div>
            <div class="kpi-sub"><div class="sub-label">YTD · Jan–… vs prior year — Total</div><div class="value">—</div><div class="delta"></div></div>
            <div class="kpi-sub"><div class="sub-label">Days on Market (Median)</div><div class="value">—</div><div class="delta"></div></div>
          </div>
          <div class="kpi">
            <div class="label">Tampa–St. Petersburg–Clearwater</div>
            <div class="kpi-sub"><div class="sub-label">Latest Month · Units authorized (NSA) — Total</div><div class="value">—</div><div class="delta"></div></div>
            <div class="kpi-sub"><div class="sub-label">YTD · Jan–… vs prior year — Total</div><div class="value">—</div><div class="delta"></div></div>
            <div class="kpi-sub"><div class="sub-label">Days on Market (Median)</div><div class="value">—</div><div class="delta"></div></div>
          </div>
          <div class="kpi">
            <div class="label">Ocala Metro Area</div>
            <div class="kpi-sub"><div class="sub-label">Latest Month · Units authorized (NSA) — Total</div><div class="value">—</div><div class="delta"></div></div>
            <div class="kpi-sub"><div class="sub-label">YTD · Jan–… vs prior year — Total</div><div class="value">—</div><div class="delta"></div></div>
            <div class="kpi-sub"><div class="sub-label">Days on Market (Median)</div><div class="value">—</div><div class="delta"></div></div>
          </div>
          <div class="kpi">
            <div class="label">Palm Bay–Melbourne–Titusville</div>
            <div class="kpi-sub"><div class="sub-label">Latest Month · Units authorized (NSA) — Total</div><div class="value">—</div><div class="delta"></div></div>
            <div class="kpi-sub"><div class="sub-label">YTD · Jan–… vs prior year — Total</div><div class="value">—</div><div class="delta"></div></div>
            <div class="kpi-sub"><div class="sub-label">Days on Market (Median)</div><div class="value">—</div><div class="delta"></div></div>
          </div>
        </div>

        <p class="fine" style="margin-top:8px">
          <strong>Permits</strong> = units authorized (Census BPS via FRED), NSA monthly. <strong>DOM</strong> = median Days on Market (Realtor.com/Redfin proxies via FRED where available).
        </p>
      </div>
    </div>

    <!-- 3) WATCHLIST — FULL LIST -->
    <div class="card">
      <h3>Watchlist — Full List</h3>
      <div class="content">
        <div class="stocks-wrap" id="stocksWrap">
          <!-- We’ll render the full list below; this wrapper scrolls -->
        </div>
      </div>
    </div>

    <!-- 4) FEED TICKER — v6 FINAL block format -->
    <div class="card">
      <h3>## FEED: RE Ticker — <span id="feedTime">—</span> — <span id="feedDate">—</span></h3>
      <div class="content">
        <div class="feed-wrap" id="feedWrap">
          <div class="section-title">(1) Changes Today</div>
          <div id="today"></div>

          <div class="section-title">(2) Month-over-Month (MoM)</div>
          <div id="mom"></div>

          <div class="section-title">(3) Quarter-to-Date (or longer)</div>
          <div id="qtd"></div>

          <div class="section-title">Summary Takeaways (No Sugarcoat)</div>
          <div class="summary" id="takeaways">—</div>
        </div>
      </div>
    </div>

  </div>
</main>

<script>
  // --- Utilities ---
  const cls = (x)=> (x>0?'pos':(x<0?'neg':'flat'));
  const fmtPct = (x,d=1)=> (x==null?'—':((x>=0?'+':'')+(100*x).toFixed(d)+'%'));
  const setText = (el, v)=>{ if(el) el.textContent = v; };
  const setHTML = (el, v)=>{ if(el) el.innerHTML = v; };
  const $ = (s)=>document.querySelector(s);

  // Buttons
  document.getElementById('downloadHtml').addEventListener('click', ()=>{
    const blob = new Blob([document.documentElement.outerHTML], {type:'text/html'});
    const url = URL.createObjectURL(blob); const a=document.createElement('a');
    a.href=url; a.download='market_housing_dashboard_v6_FINAL.html'; a.click(); URL.revokeObjectURL(url);
  });

  function blockHTML(h,what,numbers,just,why,market){
    return `<div class="block"><h4>${h}</h4>
      <div class="lines">
        <div><span class="label">What:</span><span class="text">${what||'—'}</span></div>
        <div><span class="label">Numbers:</span><span class="text">${numbers||'—'}</span></div>
        <div><span class="label">Justified by:</span><span class="text">${just||'—'}</span></div>
        <div><span class="label">Why it matters:</span><span class="text">${why||'—'}</span></div>
        <div><span class="label">Market take:</span><span class="text">${market||'—'}</span></div>
      </div></div>`;
  }

  function feedTextFromDOM(){
    const now=new Date();
    const head=`## FEED: RE Ticker — ${now.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})} — ${now.toLocaleDateString()}\n\nBelow is a concise “ticker” style update for real estate & housing macro / capital markets.\n`;
    const toText = (sel)=>{
      const nodes=document.querySelectorAll(sel+" .block");
      let out=""; nodes.forEach(n=>{
        const cat=n.querySelector('h4').textContent.trim();
        const texts=n.querySelectorAll('.text');
        const [what,nums,just,why,market]=Array.from(texts).map(x=>x.textContent.trim());
        out+=`\n${cat}\n  • What: ${what}\n  • Numbers: ${nums}\n  • Justified by: ${just}\n  • Why / Outlook: ${why}\n  • Market take: ${market}\n`;
      }); return out;
    };
    let txt=head;
    txt += `\n(1) Changes Today\n` + toText('#today');
    txt += `\n(2) Month-over-Month (MoM)\n` + toText('#mom');
    txt += `\n(3) Quarter-to-Date (or longer)\n` + toText('#qtd');
    txt += `\nSummary Takeaways (No Sugarcoat)\n` + document.querySelector('#takeaways').innerText.split('\n').map(x=>"  • "+x).join('\n')+"\n";
    return txt;
  }
  document.getElementById('copyFeed').addEventListener('click', async ()=>{
    const text=feedTextFromDOM();
    try{ await navigator.clipboard.writeText(text); alert('FEED copied to clipboard.'); }
    catch(e){ alert('Copy failed; use Export TXT.'); }
  });
  document.getElementById('downloadTxt').addEventListener('click', ()=>{
    const blob = new Blob([feedTextFromDOM()], {type:'text/plain'});
    const url = URL.createObjectURL(blob); const a=document.createElement('a');
    a.href=url; a.download='FEED_RE_Ticker_v6_FINAL.txt'; a.click(); URL.revokeObjectURL(url);
  });

  // --- Hydrate from /data/state.json ---
  (async function(){
    let resp;
    try{ resp = await fetch('data/state.json?cb=' + Date.now()); }
    catch(e){ console.error('fetch state.json failed', e); $('#lastUpdated').textContent = 'Failed to load data.'; return; }
    if(!resp?.ok){ $('#lastUpdated').textContent = 'No data yet.'; return; }
    const S = await resp.json();

    // Header time
    setText($('#lastUpdated'), S.as_of || '—');

    // Macro
    if(S.macro?.spx){
      const p = Number(S.macro.spx.price||0);
      const d = Number(S.macro.spx.pct_1d||0);
      setText($('#spx'), p? p.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2}) : '—');
      setHTML($('#spxDelta'), d===0||isNaN(d)? '' : `<span class="${cls(d)}">${fmtPct(d,2)}</span> 1d`);
    }
    if(S.macro?.ten_year){
      const y=Number(S.macro.ten_year.yield_pct||0);
      const bp=Math.round(Number(S.macro.ten_year.delta_bp_1d||0));
      setText($('#ust10'), y? y.toFixed(2)+'%' : '—');
      setHTML($('#ust10Delta'), isNaN(bp)? '' : `<span class="${cls(bp)}">${bp>=0?'+':''}${bp}bp</span>`);
    }
    if(S.macro?.mortgage_30y){
      const y=Number(S.macro.mortgage_30y.rate_pct||0);
      const bp=Math.round(Number(S.macro.mortgage_30y.delta_bp_wow||0));
      setText($('#mort30'), y? y.toFixed(2)+'%' : '—');
      setHTML($('#mort30Delta'), isNaN(bp)? '' : `<span class="${cls(bp)}">${bp>=0?'+':''}${bp}bp</span> w/w`);
    }
    if(S.macro?.starts){
      const lvl=Number(S.macro.starts.level_saar||0);
      const mom=Number(S.macro.starts.mom||0);
      setText($('#starts'), lvl? (lvl/1_000_000).toFixed(2)+'m SAAR' : '—');
      setHTML($('#startsDelta'), isNaN(mom)? '' : `<span class="${cls(mom)}">${fmtPct(mom,1)}</span> m/m`);
    }

    // Florida Permits + DOM
    const msas = S.permits?.msa || {};
    const KEY = {
      'Orlando–Kissimmee–Sanford':'Orlando–Kissimmee–Sanford',
      'Tampa–St. Petersburg–Clearwater':'Tampa–St. Petersburg–Clearwater',
      'Ocala Metro Area':'Ocala',
      'Palm Bay–Melbourne–Titusville':'Palm Bay–Melbourne–Titusville'
    };

    function renderPermits(type){
      document.querySelectorAll('#flPermitsKPI .kpi').forEach(kpi=>{
        const label = kpi.querySelector('.label')?.textContent.trim() || '';
        const M = msas[KEY[label]]; if(!M) return;
        const bucket = (type==='1unit') ? M.one_unit : M.total;
        const subs = kpi.querySelectorAll('.kpi-sub'); // [0]=Latest, [1]=YTD, [2]=DOM

        // Latest
        if(subs[0]){
          if(bucket?.latest!=null){
            subs[0].querySelector('.sub-label').textContent = `Latest Month · Units authorized (NSA) — ${type==='1unit'?'1-Unit':'Total'}`;
            subs[0].querySelector('.value').textContent = (bucket.latest).toLocaleString();
            subs[0].querySelector('.delta').innerHTML =
              `<span class="${cls(bucket.mom)}">${fmtPct(bucket.mom,1)} MoM</span> · <span class="${cls(bucket.yoy)}">${fmtPct(bucket.yoy,1)} YoY</span>`;
          }else{
            subs[0].querySelector('.value').textContent='—';
            subs[0].querySelector('.delta').textContent='—';
          }
        }
        // YTD
        if(subs[1]){
          if(bucket){
            const yr=bucket.latest_year, mname=bucket.latest_month_name||bucket.latest_month||'—';
            subs[1].querySelector('.sub-label').textContent = `YTD · Jan–${mname} ${yr} vs ${yr-1} — ${type==='1unit'?'1-Unit':'Total'}`;
            subs[1].querySelector('.value').textContent = (bucket.ytd_count??'—').toLocaleString();
            subs[1].querySelector('.delta').innerHTML =
              `<span class="${cls(bucket.ytd_yoy)}">${fmtPct(bucket.ytd_yoy,1)} Y/Y</span>`;
          }else{
            subs[1].querySelector('.value').textContent='—';
            subs[1].querySelector('.delta').textContent='—';
          }
        }
        // DOM
        if(subs[2]){
          const D=M.dom;
          if(D){
            subs[2].querySelector('.value').textContent = `${D.days} days`;
            subs[2].querySelector('.delta').innerHTML =
              `<span class="${cls(D.yoy)}">${fmtPct(D.yoy,1)} YoY</span> <span class="fine">(${D.as_of||'—'})</span>`;
          }else{
            subs[2].querySelector('.value').textContent='—';
            subs[2].querySelector('.delta').textContent='—';
          }
        }
      });
    }
    document.querySelectorAll('#typeToggle button').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        document.querySelectorAll('#typeToggle button').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        renderPermits(btn.dataset.type);
      });
    });
    renderPermits('total');

    // Watchlist (hydrate if S.watchlist exists; else show full static list with placeholders)
    const DEFAULT_LIST = [
      ["DHI","D.R. Horton"],["LEN","Lennar"],["NVR","NVR"],["TOL","Toll Brothers"],["PHM","PulteGroup"],["KBH","KB Home"],
      ["MTH","Meritage"],["GRBK","Green Brick"],["BLDR","Builders FirstSource"],["HD","Home Depot"],["LOW","Lowe's"],
      ["XHB","SPDR Homebuilders"],["ITB","iShares Home Construction"],
      ["VNQ","Vanguard REIT"],["SPG","Simon Property"],["PLD","Prologis"],["AMT","American Tower"],["MAA","Mid-America Apt"],
      ["AVB","AvalonBay"],["EQR","Equity Residential"],["O","Realty Income"],["INVH","Invitation Homes"],["AMH","American Homes 4 Rent"],
      ["Z","Zillow"],["RDFN","Redfin"],["OPEN","Opendoor"],["OPAD","Offerpad"],
      ["RKT","Rocket"],["UWMC","UWM"],["BAC","Bank of America"],["WFC","Wells Fargo"],["JPM","JPMorgan"],["USB","U.S. Bancorp"]
    ];
    const DESCRIPTIONS = {
      "DHI":"Largest builder; entry-level muscle.",
      "LEN":"Big builder; FL/TX footprint, options-heavy.",
      "NVR":"Asset-light builder; ruthless buybacks.",
      "TOL":"Luxury homes; margins, mood lighting.",
      "PHM":"Scale builder; move-up exposure.",
      "KBH":"West/Sun Belt; first-time skew.",
      "MTH":"Entry-to-move-up; Sun Belt bias.",
      "GRBK":"Texas growth engine; niche swagger.",
      "BLDR":"Pro contractor supplier; price leverage.",
      "HD":"Home improvement mothership; Pro bellwether.",
      "LOW":"HD’s rival; catching Pro share.",
      "XHB":"Homebuilder/supplier ETF; diversified.",
      "ITB":"Builder-heavy ETF; beta on housing.",
      "VNQ":"Broad REIT ETF; yield vehicle.",
      "SPG":"A-mall REIT; dividends and Dior.",
      "PLD":"Logistics REIT; boxes for everything.",
      "AMT":"Tower REIT; 5G rent escalators.",
      "MAA":"Sun Belt multifamily; steady eddy.",
      "AVB":"Coastal Class-A apartments; cyclical.",
      "EQR":"Urban coastal apts; regulation vibes.",
      "O":"Net-lease REIT; monthly rent checks.",
      "INVH":"SFR landlord; scaled operations.",
      "AMH":"SFR REIT; build-to-rent push."
    };
    const wrap=$("#stocksWrap"); wrap.innerHTML='';
    const WL = Array.isArray(S.watchlist)? S.watchlist.map(x=>[x.symbol, x.name||x.symbol]) : DEFAULT_LIST;
    WL.forEach(([t,n])=>{
      const desc = DESCRIPTIONS[t] || "Company in housing stack.";
      const price = (S.watchlist?.find(w=>w.symbol===t)?.price);
      const ch = (S.watchlist?.find(w=>w.symbol===t)?.pct_1d);
      const chTxt = (ch==null)? '—' : ((ch>0?'+':'')+(100*ch).toFixed(2)+'%');
      const chCls = ch==null? 'style="color:#64748b"' : (ch>0? 'style="color:#16a34a"' : (ch<0? 'style="color:#dc2626"':'style="color:#64748b"'));
      wrap.insertAdjacentHTML('beforeend',
        `<div class="stock-row">
           <div class="ticker">${t}</div>
           <div class="name">${n}</div>
           <div class="desc">${desc}</div>
           <div class="price">${price==null?'—':('$'+Number(price).toFixed(2))}</div>
           <div ${chCls}>${chTxt}</div>
         </div>`);
    });

    // FEED: render v6 block format from S.feed if provided
    const sections = [['today','#today'], ['mom','#mom'], ['qtd','#qtd']];
    const now = new Date();
    setText($('#feedTime'), now.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}));
    setText($('#feedDate'), now.toLocaleDateString());

    function renderFeedBlocks(){
      const F = S.feed || {};
      sections.forEach(([key, sel])=>{
        const arr = Array.isArray(F[key]) ? F[key] : [];
        const mount = document.querySelector(sel);
        mount.innerHTML = arr.length ? '' : '<div class="fine">No items yet.</div>';
        arr.forEach(item=>{
          mount.insertAdjacentHTML('beforeend',
            blockHTML(item.h||'—', item.what, item.numbers, item.justify, item.why, item.market));
        });
      });
    }
    renderFeedBlocks();

    // Takeaways from available data
    function generateTakeaways(){
      const mort = $('#mort30')?.innerText || '';
      const mortDelta = $('#mort30Delta')?.innerText || '';
      const ust10 = $('#ust10')?.innerText || '';
      let upPerm=0, downPerm=0, leader=null, bestMoM=-1e9;

      Object.values(msas).forEach(M=>{
        const b = (document.querySelector('#typeToggle .active')?.dataset.type==='1unit')? M.one_unit : M.total;
        if(b?.mom>0) upPerm++; else if(b?.mom<0) downPerm++;
        if(b?.mom!=null && b.mom>bestMoM){ bestMoM=b.mom; leader= (M?.label)||''; }
      });

      const bullets = [
        `Mortgage ${mort} (${mortDelta||'—'}).`,
        `10Y ${ust10}.`,
        `Permits breadth: ${upPerm} up / ${downPerm} down m/m${leader?`; leader ≈ strongest MoM`:''}.`,
        `DOM data wired to state.json; watch changes where DOM is rising.`,
      ];
      $('#takeaways').innerHTML = "• " + bullets.join("<br/>• ");
    }
    generateTakeaways();
    document.getElementById('refreshTakeaways').addEventListener('click', generateTakeaways);
  })();
</script>
</body>
</html>
