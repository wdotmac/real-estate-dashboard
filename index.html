<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Real Estate Daily Dashboard</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial, sans-serif; }
    body { margin: 0; color: #111; background: #fff; }
    header { padding: 16px; border-bottom: 1px solid #eee; }
    main { max-width: 1200px; margin: 0 auto; padding: 16px; }
    h1 { font-size: 20px; margin: 0; }
    h2 { margin: 10px 0 8px; font-size: 16px; }
    .asof { color: #666; font-size: 12px; margin-top: 4px; }
    section { margin: 24px 0; }
    .card { border: 1px solid #eee; border-radius: 12px; padding: 16px; background: #fff; }
    .grid { display: grid; gap: 12px; }
    .grid.cols-2 { grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); }
    .kpi-label { color: #666; font-size: 12px; }
    .kpi-value { font-size: 22px; margin: 6px 0 8px; }
    .kpi-sub { color: #666; font-size: 12px; }
    .pos { color: #0a7a21; }
    .neg { color: #b00020; }
    table { width: 100%; border-collapse: collapse; font-size: 14px; }
    th, td { padding: 8px; border-bottom: 1px solid #f0f0f0; text-align: left; }
    th { background: #fafafa; position: sticky; top: 0; z-index: 1; }
    .muted { color: #666; font-size: 12px; }
    .ticker { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    /* FEED ticker */
    .feedbar { border: 1px solid #eee; border-radius: 12px; padding: 10px 12px; background: #fff; }
    .feeditem { font-size: 14px; margin: 6px 0; }
    .feeditem a { text-decoration: none; color: #0366d6; }
    .tabs { display: flex; gap: 6px; margin-bottom: 8px; }
    .tab { font-size: 12px; padding: 6px 10px; border: 1px solid #eee; border-radius: 16px; cursor: default; background: #fafafa; }
  </style>
</head>
<body>
  <header>
    <h1>Real Estate Daily Dashboard</h1>
    <div class="asof" id="asof">Loading…</div>
  </header>
  <main>
    <!-- 1) Macro Snapshot -->
    <section>
      <h2>1) Macro Snapshot</h2>
      <div id="macro" class="grid cols-2"></div>
    </section>

    <!-- 2) Florida Permits (finalized) -->
    <section>
      <h2>2) Florida Permits</h2>
      <div class="card">
        <div class="tabs">
          <div class="tab">Finalized — Florida (Monthly)</div>
        </div>
        <div id="permits-meta" class="muted" style="margin-bottom:8px;"></div>
        <div style="overflow:auto">
          <table id="permits-table"></table>
        </div>
      </div>
    </section>

    <!-- 3) Watchlist — Full List -->
    <section>
      <h2>3) Watchlist — Full List</h2>
      <div class="card" style="padding:0;">
        <div style="overflow:auto">
          <table id="watchlist"></table>
        </div>
      </div>
    </section>

    <!-- 4) FEED Ticker -->
    <section>
      <h2>4) FEED Ticker</h2>
      <div id="feed" class="feedbar"></div>
    </section>
  </main>

  <script>
    const fmtPct = (x) => (x === null || x === undefined) ? '—' : (x>0?'+':'') + (100*x).toFixed(2) + '%';
    const fmtNum = (x, d=2) => (x === null || x === undefined) ? '—' : Number(x).toFixed(d);
    const cls = (x) => (x>0? 'pos' : (x<0? 'neg' : ''));

    function ensureSections(s) {
      // Ensure all major keys exist so UI never blanks out
      s.macro ||= {};
      s.permits ||= {};
      s.permits.florida ||= {};
      s.permits.florida.table ||= [];
      s.watchlist ||= [];
      s.feed ||= [];
      return s;
    }

    fetch('data/state.json?cb=' + Date.now())
      .then(r => r.json())
      .then(s0 => {
        const s = ensureSections(s0);
        document.getElementById('asof').textContent = 'As of ' + (s.as_of || '—');

        // 1) Macro Snapshot cards (order you care about)
        const macroOrder = ['ten_year','two_year','mortgage_30y','cpi'];
        const macro = document.getElementById('macro');
        macroOrder.forEach(k => {
          const m = s.macro[k];
          if (!m) return;
          const el = document.createElement('div');
          el.className = 'card';
          el.innerHTML = `
            <div class="kpi-label">${m.label || k}</div>
            <div class="kpi-value">${m.pretty ?? fmtNum(m.latest)}</div>
            <div class="kpi-sub">
              MoM: <span class="${cls(m.mom)}">${fmtPct(m.mom)}</span> ·
              YoY: <span class="${cls(m.yoy)}">${fmtPct(m.yoy)}</span> ·
              YTD: <span class="${cls(m.ytd)}">${fmtPct(m.ytd)}</span>
            </div>`;
          macro.appendChild(el);
        });

        // 2) Florida Permits table + meta
        const pf = s.permits.florida;
        const pmeta = document.getElementById('permits-meta');
        const ptable = document.getElementById('permits-table');
        if (pf.latest != null) {
          pmeta.innerHTML = `
            Latest: <b>${pf.latest_date || '—'}</b>
            · Value: <b>${fmtNum(pf.latest, 0)}</b>
            · MoM: <span class="${cls(pf.mom)}">${fmtPct(pf.mom)}</span>
            · YoY: <span class="${cls(pf.yoy)}">${fmtPct(pf.yoy)}</span>
            · YTD: <span class="${cls(pf.ytd)}">${fmtPct(pf.ytd)}</span>`;
        } else {
          pmeta.textContent = 'No permits data yet.';
        }
        const rows = pf.table || [];
        let html = '<thead><tr><th>Date</th><th>Permits</th></tr></thead><tbody>';
        rows.forEach(r => { html += `<tr><td>${r.date}</td><td>${r.value}</td></tr>`; });
        html += '</tbody>';
        ptable.innerHTML = html;

        // 3) Watchlist — Full List
        const w = document.getElementById('watchlist');
        const items = s.watchlist;
        let whtml = '<thead><tr><th>Ticker</th><th>Price</th><th>1D</th><th>WTD</th><th>MTD</th><th>YTD</th></tr></thead><tbody>';
        items.forEach(t => {
          whtml += `<tr>
            <td class="ticker">${t.symbol}</td>
            <td>${fmtNum(t.price, 2)}</td>
            <td class="${cls(t.pct_1d)}">${fmtPct(t.pct_1d)}</td>
            <td class="${cls(t.pct_wtd)}">${fmtPct(t.pct_wtd)}</td>
            <td class="${cls(t.pct_mtd)}">${fmtPct(t.pct_mtd)}</td>
            <td class="${cls(t.pct_ytd)}">${fmtPct(t.pct_ytd)}</td>
          </tr>`;
        });
        whtml += '</tbody>';
        w.innerHTML = whtml;

        // 4) FEED Ticker (always visible if entries exist)
        const f = document.getElementById('feed');
        f.innerHTML = '';
        if (!s.feed.length) {
          f.innerHTML = '<div class="muted">No headlines yet.</div>';
        } else {
          s.feed.forEach(it => {
            const d = document.createElement('div');
            d.className = 'feeditem';
            const ts = it.published ? ` · ${it.published}` : '';
            d.innerHTML = `• <a href="${it.link}" target="_blank" rel="noopener noreferrer">${it.title}</a>${ts}`;
            f.appendChild(d);
          });
        }
      })
      .catch(err => {
        document.getElementById('asof').textContent = 'Failed to load data/state.json';
        console.error(err);
      });
  </script>
</body>
</html>
