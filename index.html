<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Market & Housing Dashboard — v6 FINAL (Hydrated from state.json)</title>
<style>
  :root{
    --bg1:#f6f8ff; --bg2:#eef7ff;
    --text:#0f172a; --muted:#475569; --soft:#64748b;
    --card:#ffffff; --border:#e6e9f2; --primary:#0b63f6;
    --ok:#16a34a; --bad:#dc2626; --flat:#64748b;
    --accentA:#e9f1ff; --accentB:#f0e9ff;
    --radius:14px; --shadow:0 10px 32px rgba(10,14,25,.10);
    --fz:16px; --fz-sm:14px; --fz-lg:18px;
    --pad:18px; --gap:16px; --maxw:1240px;
  }
  *{box-sizing:border-box}
  body{
    margin:0;color:var(--text);font:var(--fz)/1.7 Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    background:linear-gradient(180deg, var(--bg1), var(--bg2)) fixed;
  }
  body::before, body::after{
    content:""; position:fixed; top:0; bottom:0; width:10px; pointer-events:none;
    background:linear-gradient(180deg, var(--accentA), transparent 60%);
  }
  body::before{ left:0 }
  body::after{ right:0; background:linear-gradient(180deg, var(--accentB), transparent 60%) }

  a{color:#0b63f6;text-decoration:none}
  header{position:sticky;top:0;z-index:1000;background:rgba(255,255,255,.9);backdrop-filter:blur(8px);border-bottom:1px solid var(--border)}
  .wrap{max-width:var(--maxw);margin:0 auto;padding:12px var(--pad)}
  .bar{display:flex;align-items:center;justify-content:space-between;gap:12px}
  .brand{display:flex;align-items:center;gap:10px;font-weight:800;font-size:20px}
  .logo{width:30px;height:30px;border-radius:9px;background:linear-gradient(135deg,#0b63f6,#7c3aed)}
  .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .btn{background:#0b63f6;color:#fff;padding:9px 13px;border-radius:10px;cursor:pointer;border:1px solid #0b5be0;box-shadow:var(--shadow);font-weight:600}
  .btn.secondary{background:#fff;color:#0b63f6;border:1px solid var(--border)}
  .chip{background:#eef2ff;color:#1e293b;border:1px solid var(--border);padding:6px 10px;border-radius:999px;font-size:var(--fz-sm)}

  main{padding:var(--pad)}
  .grid{display:grid;gap:22px;grid-template-columns:1fr}
  .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden}
  .card h3{margin:0;padding:14px var(--pad);background:linear-gradient(180deg,#ffffff,#fbfbff);border-bottom:1px solid var(--border);font-size:var(--fz-lg);color:#1f2937;letter-spacing:.2px}
  .content{padding:var(--pad)}

  /* KPI grid */
  .kpis{display:grid;gap:14px;grid-template-columns:repeat(4,1fr)}
  .kpi{display:flex;flex-direction:column;gap:10px;background:#fff;border:1px solid var(--border);border-radius:12px;padding:12px}
  .kpi .label{color:#0f172a;font-size:15px;font-weight:800}
  .kpi-sub{border:1px dashed var(--border);border-radius:10px;padding:10px;background:#fcfdff}
  .sub-label{color:#64748b;font-size:12px;text-transform:uppercase;letter-spacing:.4px;margin-bottom:6px}
  .value{font-size:24px;font-weight:800}
  .delta{font-size:13px;color:#475569}
  .pos{color:var(--ok)} .neg{color:var(--bad)} .flat{color:var(--flat)}
  .fine{color:#64748b;font-size:12px}

  /* Type toggle */
  .toggle{display:inline-flex;border:1px solid var(--border);border-radius:12px;overflow:hidden;background:#fff}
  .toggle button{padding:8px 12px;border:none;background:#fff;color:#0b63f6;font-weight:700;cursor:pointer}
  .toggle button.active{background:#0b63f6;color:#fff}
  .toggle button+button{border-left:1px solid var(--border)}

  /* Watchlist */
  .stocks-wrap{max-height:520px;overflow:auto;border:1px solid var(--border);border-radius:12px;background:#fff}
  .stock-row{display:grid;grid-template-columns:110px 180px 1fr 120px 120px;gap:10px;align-items:center;padding:12px 14px;border-bottom:1px dashed var(--border)}
  .stock-row:last-child{border-bottom:none}
  .ticker{font-weight:800;color:#111827}
  .name{color:#1f2937;font-weight:600}
  .desc{color:#475569;font-size:14px}
  .price{font-variant-numeric:tabular-nums}

  /* FEED */
  .feed-wrap{max-height:680px;overflow:auto;border:1px solid var(--border);border-radius:12px;background:#fff;padding:14px}
  .section-title{margin:14px 0 10px;font-weight:800;color:#1f2937;font-size:var(--fz-lg)}
  .block{border:1px solid var(--border);border-radius:12px;background:#fff;padding:14px;margin-bottom:14px}
  .block h4{margin:0 0 8px;font-size:17px;color:#111827}
  .lines{display:grid;gap:6px}
  .label{color:#64748b;font-size:var(--fz-sm);width:180px;display:inline-block}
  .text{color:#0f172a}
  .summary{border:2px dashed var(--border);border-radius:12px;background:#fcfdff;padding:14px;font-weight:600}

  @media (max-width: 1000px){ .kpis{grid-template-columns:repeat(2,1fr)} }
  @media (max-width: 640px){ .kpis{grid-template-columns:1fr} }
</style>
</head>
<body>
<header>
  <div class="wrap bar">
    <div class="brand"><div class="logo"></div><div>Market & Housing — v6 FINAL</div></div>
    <div class="toolbar">
      <span class="chip">Updated: <span id="lastUpdated">—</span></span>
      <button class="btn secondary" id="refreshTakeaways">Refresh Takeaways</button>
      <button class="btn" id="downloadHtml">Download HTML</button>
    </div>
  </div>
</header>

<main>
  <div class="wrap grid">

    <!-- 1) MACRO SNAPSHOT -->
    <div class="card">
      <h3>Macro Snapshot</h3>
      <div class="content">
        <div class="kpis">
          <div class="kpi"><div class="label">S&amp;P 500</div><div class="value" id="spx">—</div><div class="delta" id="spxDelta"></div></div>
          <div class="kpi"><div class="label">10Y UST</div><div class="value" id="ust10">—</div><div class="delta" id="ust10Delta"></div></div>
          <div class="kpi"><div class="label">30Y Mortgage (PMMS)</div><div class="value" id="mort30">—</div><div class="delta" id="mort30Delta"></div></div>
          <div class="kpi"><div class="label">Housing Starts (SAAR)</div><div class="value" id="starts">—</div><div class="delta" id="startsDelta"></div></div>
        </div>
      </div>
    </div>

    <!-- 2) FLORIDA PERMITS — Latest + YTD + DOM with Type Toggle -->
    <div class="card">
      <h3>Florida Metro Permits — Latest Month + YTD + Days on Market</h3>
      <div class="content">
        <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px">
          <span class="fine" style="font-weight:700">Type:</span>
          <div class="toggle" id="typeToggle">
            <button class="active" data-type="total">Total</button>
            <button data-type="1unit">1-Unit</button>
          </div>
        </div>

        <div class="kpis" id="flPermitsKPI">
          <div class="kpi">
            <div class="label">Orlando–Kissimmee–Sanford</div>
            <div class="kpi-sub"><div class="sub-label">Latest Month · Units authorized (NSA) — Total</div><div class="value">—</div><div class="delta"></div></div>
            <div class="kpi-sub"><div class="sub-label">YTD · Jan–… vs prior year — Total</div><div class="value">—</div><div class="delta"></div></div>
            <div class="kpi-sub"><div class="sub-label">Days on Market (Median)</div><div class="value">—</div><div class="delta"></div></div>
          </div>
          <div class="kpi">
            <div class="label">Tampa–St. Petersburg–Clearwater</div>
            <div class="kpi-sub"><div class="sub-label">Latest Month · Units authorized (NSA) — Total</div><div class="value">—</div><div class="delta"></div></div>
            <div class="kpi-sub"><div class="sub-label">YTD · Jan–… vs prior year — Total</div><div class="value">—</div><div class="delta"></div></div>
            <div class="kpi-sub"><div class="sub-label">Days on Market (Median)</div><div class="value">—</div><div class="delta"></div></div>
          </div>
          <div class="kpi">
            <div class="label">Ocala Metro Area</div>
            <div class="kpi-sub"><div class="sub-label">Latest Month · Units authorized (NSA) — Total</div><div class="value">—</div><div class="delta"></div></div>
            <div class="kpi-sub"><div class="sub-label">YTD · Jan–… vs prior year — Total</div><div class="value">—</div><div class="delta"></div></div>
            <div class="kpi-sub"><div class="sub-label">Days on Market (Median)</div><div class="value">—</div><div class="delta"></div></div>
          </div>
          <div class="kpi">
            <div class="label">Palm Bay–Melbourne–Titusville</div>
            <div class="kpi-sub"><div class="sub-label">Latest Month · Units authorized (NSA) — Total</div><div class="value">—</div><div class="delta"></div></div>
            <div class="kpi-sub"><div class="sub-label">YTD · Jan–… vs prior year — Total</div><div class="value">—</div><div class="delta"></div></div>
            <div class="kpi-sub"><div class="sub-label">Days on Market (Median)</div><div class="value">—</div><div class="delta"></div></div>
          </div>
        </div>

        <p class="fine" style="margin-top:8px">
          <strong>Permits</strong> = units authorized (Census BPS via FRED), NSA monthly. <strong>DOM</strong> = median Days on Market (Realtor.com/Redfin proxies via FRED where available).
        </p>
      </div>
    </div>

    <!-- 3) WATCHLIST — FULL LIST (scrollable) -->
    <div class="card">
      <h3>Watchlist — Full List</h3>
      <div class="content">
        <div class="stocks-wrap" id="stocksWrap">
          <!-- rows injected by JS -->
        </div>
      </div>
    </div>

    <!-- 4) FEED: RE Ticker (placeholders until S.feed exists) -->
    <div class="card">
      <h3>FEED: RE Ticker</h3>
      <div class="content">
        <div class="feed-wrap" id="feedWrap">
          <!-- blocks injected by JS -->
        </div>
      </div>
    </div>

  </div>
</main>

<script>
  // Utilities
  const cls = (x)=> (x>0?'pos':(x<0?'neg':'flat'));
  const fmtPct = (x,d=1)=> (x==null?'—':((x>=0?'+':'')+(100*x).toFixed(d)+'%'));
  const setText = (el, v)=>{ if(el) el.textContent = v; };
  const setHTML = (el, v)=>{ if(el) el.innerHTML = v; };

  // Download HTML
  document.getElementById('downloadHtml').addEventListener('click', ()=>{
    const blob = new Blob([document.documentElement.outerHTML], {type:'text/html'});
    const url = URL.createObjectURL(blob); const a=document.createElement('a');
    a.href=url; a.download='market_housing_dashboard_v6_FINAL.html'; a.click(); URL.revokeObjectURL(url);
  });

  // Hydrate from /data/state.json
  (async function(){
    let resp;
    try{
      resp = await fetch('data/state.json?cb=' + Date.now());
    }catch(e){
      console.error('fetch state.json failed', e);
      document.getElementById('lastUpdated').textContent = 'Failed to load data.';
      return;
    }
    if(!resp.ok){
      document.getElementById('lastUpdated').textContent = 'No data yet.';
      return;
    }
    const S = await resp.json();

    // Header time
    setText(document.getElementById('lastUpdated'), S.as_of || '—');

    // Macro
    if(S.macro?.spx){
      const p = Number(S.macro.spx.price||0);
      const d = Number(S.macro.spx.pct_1d||0);
      setText(document.getElementById('spx'), p.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2}));
      setHTML(document.getElementById('spxDelta'), `<span class="${cls(d)}">${fmtPct(d,2)}</span> 1d`);
    }
    if(S.macro?.ten_year){
      const y=Number(S.macro.ten_year.yield_pct||0);
      const bp=Math.round(Number(S.macro.ten_year.delta_bp_1d||0));
      setText(document.getElementById('ust10'), y.toFixed(2)+'%');
      setHTML(document.getElementById('ust10Delta'), `<span class="${cls(bp)}">${bp>=0?'+':''}${bp}bp</span>`);
    }
    if(S.macro?.mortgage_30y){
      const y=Number(S.macro.mortgage_30y.rate_pct||0);
      const bp=Math.round(Number(S.macro.mortgage_30y.delta_bp_wow||0));
      setText(document.getElementById('mort30'), y.toFixed(2)+'%');
      setHTML(document.getElementById('mort30Delta'), `<span class="${cls(bp)}">${bp>=0?'+':''}${bp}bp</span> w/w`);
    }
    if(S.macro?.starts){
      const lvl=Number(S.macro.starts.level_saar||0);
      const mom=Number(S.macro.starts.mom||0);
      setText(document.getElementById('starts'), (lvl/1_000_000).toFixed(2)+'m SAAR');
      setHTML(document.getElementById('startsDelta'), `<span class="${cls(mom)}">${fmtPct(mom,1)}</span> m/m`);
    }

    // Florida Permits + DOM
    const msas = S.permits?.msa || {};
    const KEY = {
      'Orlando–Kissimmee–Sanford':'Orlando–Kissimmee–Sanford',
      'Tampa–St. Petersburg–Clearwater':'Tampa–St. Petersburg–Clearwater',
      'Ocala Metro Area':'Ocala',
      'Palm Bay–Melbourne–Titusville':'Palm Bay–Melbourne–Titusville'
    };

    function renderPermits(type){
      document.querySelectorAll('#flPermitsKPI .kpi').forEach(kpi=>{
        const label = kpi.querySelector('.label')?.textContent.trim() || '';
        const M = msas[KEY[label]]; if(!M) return;
        const bucket = (type==='1unit') ? M.one_unit : M.total;

        const blocks = kpi.querySelectorAll('.kpi-sub'); // [0]=Latest, [1]=YTD, [2]=DOM
        // Latest
        if(blocks[0]){
          if(bucket?.latest!=null){
            const mom=bucket.mom, yoy=bucket.yoy;
            blocks[0].querySelector('.sub-label').textContent = `Latest Month · Units authorized (NSA) — ${type==='1unit'?'1-Unit':'Total'}`;
            blocks[0].querySelector('.value').textContent = (bucket.latest).toLocaleString();
            blocks[0].querySelector('.delta').innerHTML =
              `<span class="${cls(mom)}">${fmtPct(mom,1)} MoM</span> · <span class="${cls(yoy)}">${fmtPct(yoy,1)} YoY</span>`;
          }else{
            blocks[0].querySelector('.value').textContent='—';
            blocks[0].querySelector('.delta').textContent='—';
          }
        }
        // YTD
        if(blocks[1]){
          if(bucket){
            const yr=bucket.latest_year, mname=bucket.latest_month_name||bucket.latest_month||'—';
            blocks[1].querySelector('.sub-label').textContent = `YTD · Jan–${mname} ${yr} vs ${yr-1} — ${type==='1unit'?'1-Unit':'Total'}`;
            blocks[1].querySelector('.value').textContent = (bucket.ytd_count??'—').toLocaleString();
            blocks[1].querySelector('.delta').innerHTML =
              `<span class="${cls(bucket.ytd_yoy)}">${fmtPct(bucket.ytd_yoy,1)} Y/Y</span>`;
          }else{
            blocks[1].querySelector('.value').textContent='—';
            blocks[1].querySelector('.delta').textContent='—';
          }
        }
        // DOM
        if(blocks[2]){
          const D=M.dom;
          if(D){
            blocks[2].querySelector('.value').textContent = `${D.days} days`;
            blocks[2].querySelector('.delta').innerHTML =
              `<span class="${cls(D.yoy)}">${fmtPct(D.yoy,1)} YoY</span> <span class="fine">(${D.as_of||'—'})</span>`;
          }else{
            blocks[2].querySelector('.value').textContent='—';
            blocks[2].querySelector('.delta').textContent='—';
          }
        }
      });
    }

    // Toggle wiring
    document.querySelectorAll('#typeToggle button').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        document.querySelectorAll('#typeToggle button').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        renderPermits(btn.dataset.type);
      });
    });
    renderPermits('total');

    // === Watchlist (scrollable) ===
    function renderWatchlist(){
      const WRAP = document.getElementById('stocksWrap');
      if(!WRAP) return;
      WRAP.innerHTML = '';

      // Use S.watchlist if present; else default list with descriptions
      const DEFAULT = [
        ["DHI","D.R. Horton","Largest builder; entry-level muscle."],
        ["LEN","Lennar","Big builder; FL/TX footprint, options-heavy."],
        ["NVR","NVR","Asset-light builder; ruthless buybacks."],
        ["TOL","Toll Brothers","Luxury homes; margins, mood lighting."],
        ["PHM","PulteGroup","Scale builder; move-up exposure."],
        ["KBH","KB Home","West/Sun Belt; first-time skew."],
        ["MTH","Meritage","Entry-to-move-up; Sun Belt bias."],
        ["GRBK","Green Brick","Texas growth engine; niche swagger."],
        ["BLDR","Builders FirstSource","Pro contractor supplier; price leverage."],
        ["HD","Home Depot","Home improvement mothership; Pro bellwether."],
        ["LOW","Lowe's","HD’s rival; catching Pro share."],
        ["XHB","SPDR Homebuilders","Homebuilder/supplier ETF; diversified."],
        ["ITB","iShares Home Construction","Builder-heavy ETF; beta on housing."],
        ["VNQ","Vanguard REIT","Broad REIT ETF; yield vehicle."],
        ["SPG","Simon Property","A-mall REIT; dividends and Dior."],
        ["PLD","Prologis","Logistics REIT; boxes for everything."],
        ["AMT","American Tower","Tower REIT; 5G rent escalators."],
        ["MAA","Mid-America Apt","Sun Belt multifamily; steady eddy."],
        ["AVB","AvalonBay","Coastal Class-A apartments; cyclical."],
        ["EQR","Equity Residential","Urban coastal apts; regulation vibes."],
        ["O","Realty Income","Net-lease REIT; monthly rent checks."],
        ["INVH","Invitation Homes","SFR landlord; scaled operations."],
        ["AMH","American Homes 4 Rent","SFR REIT; build-to-rent push."],
        ["Z","Zillow","Housing portal; ad machine (PA)."],
        ["RDFN","Redfin","Brokerage + portal; thin margins."],
        ["OPEN","Opendoor","iBuyer; inventory roulette wheel."],
        ["OPAD","Offerpad","Smaller iBuyer; Southeast survivor."],
        ["RKT","Rocket","Mortgage factory; refi lever."],
        ["UWMC","UWM","Wholesale mortgage king; brokers first."],
        ["BAC","Bank of America","Big bank; consumer + mortgage."],
        ["WFC","Wells Fargo","Consumer bank; servicing baggage."],
        ["JPM","JPMorgan","Mega bank; fortress balance sheet."],
        ["USB","U.S. Bancorp","Regional bank; payments chops."]
      ];

      const LIST = Array.isArray(S.watchlist) && S.watchlist.length
        ? S.watchlist.map(o=>[o.t||o.ticker||'—', o.n||o.name||'—', o.desc||'',
                              o.price??null, o.chg??null])
        : DEFAULT.map(([t,n,desc])=>[t,n,desc,null,null]);

      LIST.forEach(([t,n,desc,price,chg])=>{
        const chgTxt = (chg==null)?'—':((chg>0?'+':'')+(chg*100).toFixed(2)+'%');
        const chgCls = (chg==null)?'style="color:#64748b"':(chg>0?'style="color:#16a34a"':'style="color:#dc2626"');
        WRAP.insertAdjacentHTML('beforeend', `
          <div class="stock-row">
            <div class="ticker">${t}</div>
            <div class="name">${n}</div>
            <div class="desc">${desc||''}</div>
            <div class="price">${price==null?'—':('$'+Number(price).toFixed(2))}</div>
            <div ${chgCls}>${chgTxt}</div>
          </div>
        `);
      });
    }
    renderWatchlist();

    // === FEED placeholders (render from S.feed if present) ===
    function blockHTML(cat, what, numbers, just, why, market){
      return `<div class="block"><h4>${cat}</h4>
        <div class="lines">
          <div><span class="label">What:</span><span class="text">${what}</span></div>
          <div><span class="label">Numbers:</span><span class="text">${numbers}</span></div>
          <div><span class="label">Justified by:</span><span class="text">${just}</span></div>
          <div><span class="label">Why it matters:</span><span class="text">${why}</span></div>
          <div><span class="label">Market take:</span><span class="text">${market}</span></div>
        </div></div>`;
    }
    function renderFeed(){
      const WR = document.getElementById('feedWrap');
      if(!WR) return;
      WR.innerHTML = '';

      const F = S.feed || null;
      if(F && (F.today?.length || F.mom?.length || F.qtd?.length || F.takeaways?.length)){
        // Render provided feed structure
        if(F.today?.length){
          WR.insertAdjacentHTML('beforeend','<div class="section-title">(1) Changes Today</div>');
          F.today.forEach(b=> WR.insertAdjacentHTML('beforeend', blockHTML(...b)));
        }
        if(F.mom?.length){
          WR.insertAdjacentHTML('beforeend','<div class="section-title">(2) Month-over-Month (MoM)</div>');
          F.mom.forEach(b=> WR.insertAdjacentHTML('beforeend', blockHTML(...b)));
        }
        if(F.qtd?.length){
          WR.insertAdjacentHTML('beforeend','<div class="section-title">(3) Quarter-to-Date (or longer)</div>');
          F.qtd.forEach(b=> WR.insertAdjacentHTML('beforeend', blockHTML(...b)));
        }
        if(F.takeaways?.length){
          WR.insertAdjacentHTML('beforeend','<div class="section-title">Summary Takeaways (No Sugarcoat)</div>');
          WR.insertAdjacentHTML('beforeend', `<div class="summary">${F.takeaways.map(x=>'• '+x).join('<br>')}</div>`);
        }
      }else{
        // Clean placeholders (no data yet)
        WR.insertAdjacentHTML('beforeend','<div class="section-title">(1) Changes Today</div>');
        WR.insertAdjacentHTML('beforeend', blockHTML(
          'Awaiting feed data',
          'No items yet.',
          '—','—','Add feed to data/state.json','—'
        ));
        WR.insertAdjacentHTML('beforeend','<div class="section-title">(2) Month-over-Month (MoM)</div>');
        WR.insertAdjacentHTML('beforeend', blockHTML(
          'Awaiting feed data',
          'No items yet.',
          '—','—','Add feed to data/state.json','—'
        ));
        WR.insertAdjacentHTML('beforeend','<div class="section-title">(3) Quarter-to-Date (or longer)</div>');
        WR.insertAdjacentHTML('beforeend', blockHTML(
          'Awaiting feed data',
          'No items yet.',
          '—','—','Add feed to data/state.json','—'
        ));
        WR.insertAdjacentHTML('beforeend','<div class="section-title">Summary Takeaways (No Sugarcoat)</div>');
        WR.insertAdjacentHTML('beforeend', `<div class="summary">• FEED not provided yet. Add a <code>feed</code> object to <code>data/state.json</code> (keys: <code>today</code>, <code>mom</code>, <code>qtd</code>, <code>takeaways</code>)</div>`);
      }
    }
    renderFeed();

    // Refresh Takeaways button just re-renders FEED
    document.getElementById('refreshTakeaways').addEventListener('click', renderFeed);

  })();
</script>
</body>
</html>
