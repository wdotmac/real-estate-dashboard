<script>
/* FINAL dashboard data hydration â€” uses data/state.json produced by GitHub Actions */
(async function () {
  // Fetch state.json (cache-buster to avoid stale CDN)
  let resp;
  try {
    resp = await fetch('data/state.json?cb=' + Date.now());
  } catch (e) {
    console.error('Failed to fetch state.json', e);
    document.getElementById('lastUpdated')?.replaceChildren('Failed to load data.');
    return;
  }
  if (!resp.ok) {
    document.getElementById('lastUpdated')?.replaceChildren('No data yet.');
    return;
  }
  const S = await resp.json();

  // Helpers
  const fmtPct = (x, d=2) => (x === null || x === undefined) ? 'â€”' : ((x>=0?'+':'') + (100*x).toFixed(d) + '%');
  const cls = (x) => (x>0?'pos':(x<0?'neg':'flat'));
  const setHTML = (el, html) => { if (el) el.innerHTML = html; };
  const setText = (el, txt) => { if (el) el.textContent = txt; };

  // 1) Header "As of"
  setText(document.getElementById('lastUpdated'), S.as_of || 'â€”');

  // 2) Macro cards (S&P 500, 10Y, 30Y Mortgage, Housing Starts)
  if (S.macro?.spx) {
    const p = Number(S.macro.spx.price || 0);
    const d = Number(S.macro.spx.pct_1d || 0);
    setText(document.getElementById('spx'), p.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2}));
    setHTML(document.getElementById('spxDelta'),
      `<span class="${cls(d)}">${fmtPct(d,2)}</span> 1d`);
  }
  if (S.macro?.ten_year) {
    // ten_year.yield_pct is a percent like 4.27 (not 0.0427)
    const y = Number(S.macro.ten_year.yield_pct || 0);
    const bp = Math.round(Number(S.macro.ten_year.delta_bp_1d || 0));
    setText(document.getElementById('ust10'), y.toFixed(2) + '%');
    setHTML(document.getElementById('ust10Delta'),
      `<span class="${cls(bp)}">${bp>=0?'+':''}${bp}bp</span>`);
  }
  if (S.macro?.mortgage_30y) {
    const y = Number(S.macro.mortgage_30y.rate_pct || 0);
    const bp = Math.round(Number(S.macro.mortgage_30y.delta_bp_wow || 0));
    setText(document.getElementById('mort30'), y.toFixed(2) + '%');
    setHTML(document.getElementById('mort30Delta'),
      `<span class="${cls(bp)}">${bp>=0?'+':''}${bp}bp</span> w/w`);
  }
  if (S.macro?.starts) {
    const lvl = Number(S.macro.starts.level_saar || 0); // SAAR units
    const mom = Number(S.macro.starts.mom || 0);
    setText(document.getElementById('starts'), (lvl/1_000_000).toFixed(2) + 'm SAAR');
    setHTML(document.getElementById('startsDelta'),
      `<span class="${cls(mom)}">${fmtPct(mom,1)}</span> m/m`);
  }

  // 3) Florida Permits â€” by Metro (Total vs 1-Unit)
  const msas = S.permits?.msa || {};
  const dom = (m) => m?.dom ? m.dom : null;

  // ðŸ”§ Correct mappings from visible labels â†’ JSON keys (must match exactly)
  const KEY = {
    'Orlandoâ€“Kissimmeeâ€“Sanford': 'Orlandoâ€“Kissimmeeâ€“Sanford',
    'Tampaâ€“St. Petersburgâ€“Clearwater': 'Tampaâ€“St. Petersburgâ€“Clearwater', // fixed
    'Ocala Metro Area': 'Ocala',
    'Palm Bayâ€“Melbourneâ€“Titusville': 'Palm Bayâ€“Melbourneâ€“Titusville'       // fixed
  };

  function render(type) {
    document.querySelectorAll('#flPermitsKPI .kpi').forEach(kpi => {
      const label = kpi.querySelector('.label')?.textContent.trim() || '';
      const key = KEY[label] || label;
      const M = msas[key];
      const blocks = kpi.querySelectorAll('.kpi-sub'); // [0]=Latest, [1]=YTD, [2]=DOM
      if (!M || blocks.length < 3) return;

      const bucket = (type === '1unit') ? M.one_unit : M.total; // Only these two are wired now

      // 0) Latest month
      const b0 = blocks[0];
      if (bucket) {
        setText(b0.querySelector('.sub-label'), `Latest Month Â· Units authorized (NSA) â€” ${type==='1unit'?'1-Unit':'Total'}`);
        setText(b0.querySelector('.value'), (bucket.latest ?? 'â€”').toLocaleString());
        const mom = bucket.mom, yoy = bucket.yoy;
        setHTML(b0.querySelector('.delta'),
          `<span class="${cls(mom)}">${fmtPct(mom,1)} MoM</span> Â· <span class="${cls(yoy)}">${fmtPct(yoy,1)} YoY</span>`);
      } else {
        setText(b0.querySelector('.sub-label'), `Latest Month â€” ${type==='1unit'?'1-Unit':'Total'}`);
        setText(b0.querySelector('.value'), 'â€”');
        setHTML(b0.querySelector('.delta'), `<span class="flat">â€”</span>`);
      }

      // 1) YTD
      const b1 = blocks[1];
      if (bucket) {
        const mname = bucket.latest_month_name || bucket.latest_month || 'â€”';
        const yr = bucket.latest_year || 'â€”';
        setText(b1.querySelector('.sub-label'), `YTD Â· Janâ€“${mname} ${yr} vs ${yr-1} â€” ${type==='1unit'?'1-Unit':'Total'}`);
        setText(b1.querySelector('.value'), (bucket.ytd_count ?? 'â€”').toLocaleString());
        setHTML(b1.querySelector('.delta'), `<span class="${cls(bucket.ytd_yoy)}">${fmtPct(bucket.ytd_yoy,1)} Y/Y</span>`);
      } else {
        setText(b1.querySelector('.sub-label'), `YTD â€” ${type==='1unit'?'1-Unit':'Total'}`);
        setText(b1.querySelector('.value'), 'â€”');
        setHTML(b1.querySelector('.delta'), `<span class="flat">â€”</span>`);
      }

      // 2) DOM (median days on market)
      const b2 = blocks[2];
      const D = dom(M);
      if (D) {
        setText(b2.querySelector('.value'), `${D.days} days`);
        setHTML(b2.querySelector('.delta'),
          `<span class="${cls(D.yoy)}">${fmtPct(D.yoy,1)} YoY</span> <span class="fine">(${D.as_of || 'â€”'})</span>`);
      } else {
        setText(b2.querySelector('.value'), 'â€”');
        setHTML(b2.querySelector('.delta'), `<span class="flat">â€”</span>`);
      }
    });
  }

  // Hook up the Type toggle
  const toggles = document.querySelectorAll('#typeToggle button');
  toggles.forEach(btn => {
    btn.addEventListener('click', () => {
      toggles.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      render(btn.dataset.type);
    });
  });

  // Initial render (use the currently "active" toggle)
  render(document.querySelector('#typeToggle button.active')?.dataset.type || 'total');
})();
</script>
