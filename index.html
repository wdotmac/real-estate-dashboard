<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Real Estate Daily Dashboard</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial, sans-serif; }
    body { margin: 0; color: #111; background: #fff; }
    header { padding: 16px; border-bottom: 1px solid #eee; }
    main { max-width: 1100px; margin: 0 auto; padding: 16px; }
    h1 { font-size: 20px; margin: 0; }
    .asof { color: #666; font-size: 12px; margin-top: 4px; }
    section { margin: 20px 0; }
    .card { border: 1px solid #eee; border-radius: 10px; padding: 16px; }
    .grid { display: grid; gap: 12px; }
    .grid.cols-2 { grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); }
    table { width: 100%; border-collapse: collapse; font-size: 14px; }
    th, td { padding: 8px; border-bottom: 1px solid #f0f0f0; text-align: left; }
    th { background: #fafafa; position: sticky; top: 0; }
    .muted { color: #666; font-size: 12px; }
    .pos { color: #0a7a21; }
    .neg { color: #b00020; }
    .ticker { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .feed a { text-decoration: none; color: #0366d6; }
  </style>
</head>
<body>
  <header>
    <h1>Real Estate Daily Dashboard</h1>
    <div class="asof" id="asof">Loading…</div>
  </header>
  <main>
    <!-- 1) Macro Snapshot -->
    <section>
      <h2>1) Macro Snapshot</h2>
      <div id="macro" class="grid cols-2"></div>
    </section>

    <!-- 2) Florida Permits (finalized) -->
    <section>
      <h2>2) Florida Permits</h2>
      <div class="card">
        <div id="permits-meta" class="muted"></div>
        <div style="overflow:auto">
          <table id="permits-table"></table>
        </div>
      </div>
    </section>

    <!-- 3) Watchlist — Full List -->
    <section>
      <h2>3) Watchlist — Full List</h2>
      <div style="overflow:auto">
        <table id="watchlist"></table>
      </div>
    </section>

    <!-- 4) FEED Ticker -->
    <section>
      <h2>4) FEED Ticker</h2>
      <div id="feed" class="feed"></div>
    </section>
  </main>

  <script>
    const fmtPct = (x) => (x === null || x === undefined) ? '—' : (x>0?'+':'') + (100*x).toFixed(2) + '%';
    const fmtNum = (x, d=2) => (x === null || x === undefined) ? '—' : Number(x).toFixed(d);
    const cls = (x) => (x>0? 'pos' : (x<0? 'neg' : ''));

    fetch('data/state.json?cb=' + Date.now())
      .then(r => r.json())
      .then(s => {
        document.getElementById('asof').textContent = 'As of ' + (s.as_of || '—');

        // 1) Macro Snapshot cards
        const macro = document.getElementById('macro');
        const macroItems = s.macro || {};
        Object.keys(macroItems).forEach(key => {
          const m = macroItems[key];
          const el = document.createElement('div');
          el.className = 'card';
          el.innerHTML = `
            <div class="muted">${m.label || key}</div>
            <div style="font-size:22px; margin:8px 0">${m.pretty || fmtNum(m.latest)}</div>
            <div class="muted">
              MoM: <span class="${cls(m.mom)}">${fmtPct(m.mom)}</span> ·
              YoY: <span class="${cls(m.yoy)}">${fmtPct(m.yoy)}</span> ·
              YTD: <span class="${cls(m.ytd)}">${fmtPct(m.ytd)}</span>
            </div>`;
          macro.appendChild(el);
        });

        // 2) Florida Permits table
        const pmeta = document.getElementById('permits-meta');
        const ptable = document.getElementById('permits-table');
        const pf = (s.permits && s.permits.florida) ? s.permits.florida : null;
        if (pf && pf.latest != null) {
          pmeta.innerHTML = `Latest: <b>${pf.latest_date || '—'}</b> · Value: <b>${fmtNum(pf.latest)}</b> · MoM: <span class="${cls(pf.mom)}">${fmtPct(pf.mom)}</span> · YoY: <span class="${cls(pf.yoy)}">${fmtPct(pf.yoy)}</span> · YTD: <span class="${cls(pf.ytd)}">${fmtPct(pf.ytd)}</span>`;
        }
        const rows = (pf && pf.table) ? pf.table : [];
        let html = '<thead><tr><th>Date</th><th>Permits</th></tr></thead><tbody>';
        rows.forEach(r => { html += `<tr><td>${r.date}</td><td>${r.value}</td></tr>`; });
        html += '</tbody>';
        ptable.innerHTML = html;

        // 3) Watchlist table
        const w = document.getElementById('watchlist');
        const items = s.watchlist || [];
        let whtml = '<thead><tr><th>Ticker</th><th>Price</th><th>1D</th><th>WTD</th><th>MTD</th><th>YTD</th></tr></thead><tbody>';
        items.forEach(t => {
          whtml += `<tr>
            <td class="ticker">${t.symbol}</td>
            <td>${fmtNum(t.price, 2)}</td>
            <td class="${cls(t.pct_1d)}">${fmtPct(t.pct_1d)}</td>
            <td class="${cls(t.pct_wtd)}">${fmtPct(t.pct_wtd)}</td>
            <td class="${cls(t.pct_mtd)}">${fmtPct(t.pct_mtd)}</td>
            <td class="${cls(t.pct_ytd)}">${fmtPct(t.pct_ytd)}</td>
          </tr>`;
        });
        whtml += '</tbody>';
        w.innerHTML = whtml;

        // 4) Feed
        const f = document.getElementById('feed');
        (s.feed || []).forEach(it => {
          const d = document.createElement('div');
          d.className = 'muted';
          const ts = it.published ? ` · ${it.published}` : '';
          d.innerHTML = `• <a href="${it.link}" target="_blank" rel="noopener noreferrer">${it.title}</a>${ts}`;
          f.appendChild(d);
        });
      })
      .catch(err => {
        document.getElementById('asof').textContent = 'Failed to load data/state.json';
        console.error(err);
      });
  </script>
</body>
</html>
